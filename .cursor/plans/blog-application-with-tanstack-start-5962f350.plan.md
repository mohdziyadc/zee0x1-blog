<!-- 5962f350-9476-4af7-8096-a6b8bc070877 4756587a-2550-416c-bd0c-023e4ea9b105 -->
# Blog Application Implementation Plan

## Architecture Overview

### Technology Stack

- **Framework**: TanStack Start (SSR-capable React framework)
- **UI**: ShadCN + Tailwind CSS (dark theme with blue tones)
- **Database**: PostgreSQL
- **ORM**: Drizzle
- **Authentication**: better-auth
- **Data Fetching**: React Query (via TanStack Router integration)
- **File Storage**: Local filesystem (public/uploads) for images

### Database Schema

#### Tables

1. **users** - Admin users (managed by better-auth, extended if needed)

   - `id` (text/varchar, primary key)
   - `email` (text, unique, indexed)
   - `name` (text, nullable)
   - `createdAt` (timestamp)
   - `updatedAt` (timestamp)

2. **posts** - Blog posts

   - `id` (serial, primary key)
   - `title` (text, not null)
   - `slug` (text, unique, indexed) - URL-friendly identifier
   - `content` (text, not null) - Markdown or HTML content
   - `excerpt` (text, nullable) - Short preview
   - `status` (text, not null) - 'draft' | 'published' (indexed)
   - `authorId` (text, not null, indexed) - References users.id
   - `publishedAt` (timestamp, nullable) - When published
   - `createdAt` (timestamp, default now)
   - `updatedAt` (timestamp, default now)
   - Indexes:
     - `idx_posts_status` on `status`
     - `idx_posts_author_id` on `authorId`
     - `idx_posts_slug` on `slug` (unique)
     - `idx_posts_published_at` on `publishedAt` DESC (for homepage queries)

3. **post_images** - Blog post images

   - `id` (serial, primary key)
   - `postId` (integer, not null, indexed) - References posts.id
   - `filename` (text, not null) - Stored filename
   - `originalFilename` (text, not null)
   - `mimeType` (text, not null)
   - `size` (integer) - File size in bytes
   - `path` (text, not null) - Relative path from public directory
   - `createdAt` (timestamp, default now)
   - Indexes:
     - `idx_post_images_post_id` on `postId`

**Note on Foreign Keys**: Using reference columns with indexes as requested. For production, consider adding foreign key constraints for data integrity.

### File Structure

```
src/
├── db/
│   ├── index.ts (existing)
│   ├── schema.ts (update with new schemas)
│   └── migrations/ (generated by drizzle-kit)
├── lib/
│   ├── utils.ts (existing)
│   ├── auth.ts (better-auth configuration)
│   └── storage.ts (image upload utilities)
├── components/
│   ├── ui/ (ShadCN components)
│   ├── Header.tsx (update)
│   ├── BlogPostCard.tsx (new)
│   ├── BlogPostList.tsx (new)
│   ├── BlogEditor.tsx (new)
│   └── AdminLayout.tsx (new)
├── routes/
│   ├── __root.tsx (update with auth context)
│   ├── index.tsx (homepage - public blog list)
│   ├── blog/
│   │   └── $slug.tsx (individual blog post page)
│   ├── admin/
│   │   ├── login.tsx (admin login)
│   │   ├── dashboard.tsx (blog list for admin)
│   │   ├── posts/
│   │   │   ├── new.tsx (create new post)
│   │   │   └── $id.tsx (edit existing post)
│   └── api/
│       ├── upload.ts (image upload endpoint)
│       └── auth/ (better-auth routes)
├── server/
│   ├── functions/
│   │   ├── posts.ts (server functions for posts)
│   │   ├── images.ts (server functions for images)
│   │   └── auth.ts (auth server functions)
└── styles.css (update for dark blue theme)
```

### Implementation Steps

#### Phase 1: Database Setup

1. Update `src/db/schema.ts` with users, posts, and post_images tables
2. Generate and run migrations using `drizzle-kit`
3. Create indexes for performance optimization

#### Phase 2: Authentication Setup

1. Install better-auth package
2. Configure better-auth in `src/lib/auth.ts`
3. Set up authentication routes in `src/routes/api/auth/`
4. Create login page at `src/routes/admin/login.tsx`
5. Implement auth middleware for protected routes
6. Update router context to include auth session

#### Phase 3: Admin Dashboard

1. Create admin layout component with navigation
2. Build admin dashboard listing all posts (drafts + published)
3. Create blog editor component with:

   - Title input
   - Markdown/rich text editor (using ShadCN components)
   - Image upload functionality
   - Save draft / Publish buttons
   - Preview mode

4. Implement server functions for:

   - Creating posts
   - Updating posts
   - Deleting posts
   - Publishing/unpublishing posts

5. Create routes for new post and edit post

#### Phase 4: Public Blog Pages

1. Update homepage (`src/routes/index.tsx`) to display published blogs
2. Create BlogPostCard component for blog preview
3. Create BlogPostList component with proper loading states
4. Implement server function to fetch published posts (SSR)
5. Create individual blog post page (`src/routes/blog/$slug.tsx`)
6. Implement server function to fetch single post by slug

#### Phase 5: Image Upload

1. Create image upload server function
2. Implement file storage in `public/uploads/`
3. Create image upload API route
4. Integrate image upload in blog editor
5. Add image display in blog post rendering

#### Phase 6: Styling & UX

1. Update theme colors for dark blue aesthetic
2. Style homepage with blog list
3. Style admin dashboard
4. Style blog editor
5. Style individual blog post pages
6. Ensure responsive design across all pages
7. Add loading states and error handling

#### Phase 7: Performance Optimization

1. Implement proper SSR for blog posts
2. Add React Query caching strategies
3. Optimize database queries with proper indexes
4. Implement image optimization/lazy loading
5. Add proper meta tags for SEO

### Key Implementation Details

#### Server Functions Pattern

```typescript
// Example: src/server/functions/posts.ts
import { createServerFn } from '@tanstack/react-start'
import { db } from '@/db'
import { posts } from '@/db/schema'
import { eq, desc } from 'drizzle-orm'

export const getPublishedPosts = createServerFn({ method: 'GET' })
  .handler(async () => {
    return await db.query.posts.findMany({
      where: eq(posts.status, 'published'),
      orderBy: [desc(posts.publishedAt)],
    })
  })

export const createPost = createServerFn({ method: 'POST' })
  .inputValidator((data: CreatePostInput) => data)
  .handler(async ({ data, request }) => {
    // Auth check
    const session = await getSession(request)
    if (!session) throw new Error('Unauthorized')
    
    // Create post
    const [post] = await db.insert(posts).values({
      title: data.title,
      content: data.content,
      status: 'draft',
      authorId: session.user.id,
      // ...
    }).returning()
    
    return post
  })
```

#### Route Loader Pattern

```typescript
// Example: src/routes/index.tsx
export const Route = createFileRoute('/')({
  loader: async () => {
    const posts = await getPublishedPosts()
    return { posts }
  },
  component: HomePage,
})
```

#### Authentication Middleware

- Use better-auth session validation in server functions
- Protect admin routes with route-level auth checks
- Provide auth context through router context

### Dependencies to Install

**Note**: better-auth and its dependencies will be added separately by the user.

```json
{
  "@radix-ui/react-dialog": "^latest",
  "@radix-ui/react-dropdown-menu": "^latest",
  "@radix-ui/react-label": "^latest",
  "@radix-ui/react-select": "^latest",
  "@radix-ui/react-textarea": "^latest",
  "react-markdown": "^latest",
  "remark-gfm": "^latest",
  "rehype-highlight": "^latest",
  "multipart-parser": "^latest"
}
```

### ShadCN Components to Install

- button
- card
- input
- textarea
- label
- select
- dialog
- dropdown-menu
- form
- toast (for notifications)

### Environment Variables

```env
DATABASE_URL=postgresql://...
BETTER_AUTH_SECRET=...
BETTER_AUTH_URL=http://localhost:3000
```

### Database Indexes Strategy

1. **posts.status** - Fast filtering of published posts
2. **posts.authorId** - Quick lookup of user's posts
3. **posts.slug** - Fast slug-based lookups (unique)
4. **posts.publishedAt DESC** - Optimized homepage queries
5. **post_images.postId** - Efficient image retrieval per post

### Notes

- All server functions use SSR where beneficial
- React Query handles client-side caching and updates
- Images stored in `public/uploads/` for direct serving
- Markdown content with code syntax highlighting
- Responsive design with mobile-first approach
- Dark theme with blue accent colors (#3b82f6, #60a5fa shades)

### To-dos

- [ ] Create database schema for users, posts, and post_images tables with proper indexes
- [ ] Install and configure better-auth with session management
- [ ] Create authentication routes and login page for admin
- [ ] Build admin dashboard with blog post list and navigation
- [ ] Create blog editor component with markdown support and image upload
- [ ] Implement server functions for CRUD operations on blog posts
- [ ] Update homepage to display published blog posts with SSR
- [ ] Create individual blog post page with slug-based routing
- [ ] Implement image upload functionality with file storage
- [ ] Apply dark blue theme across all pages with responsive design